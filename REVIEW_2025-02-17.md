# Code Review: Trees iOS/watchOS App

**Date:** 2026-02-17

**5,649 lines across 41 Swift files** — SwiftUI + SwiftData (iOS 17+) with watchOS companion, CloudKit sync, and Mac Catalyst support. Overall a well-structured app with clean separation of concerns. Below are the issues worth addressing, grouped by severity.

---

## Critical

1. **`TreesApp.swift:32` — `fatalError()` on ModelContainer init failure.** If CloudKit or SwiftData initialization fails, the app crashes with no recovery path. Should degrade gracefully (e.g., disable sync, show error).

2. **`Shared/WatchConnectivityManager.swift:142` — `receivedTrees` array never cleared.** Appended to on every receive but never drained after processing, causing unbounded memory growth during long sessions.

3. **`Trees/Views/ImportTreesView.swift:236-262` — Delayed photo import race condition.** Background task continues even if the view is dismissed. No cancellation in `.onDisappear`, so the task may reference a deallocated context.

4. **`Trees/Services/Exporters/JSONExporter.swift:51-64` — OOM risk on large exports.** All photos base64-encoded in memory simultaneously. Exporting many trees with photos can exceed available memory. Needs streaming or chunked encoding.

---

## High

5. **Silent save failures throughout.** `TreeDetailView.swift:224`, `CollectionDetailView.swift:181`, `iPadTreeListView.swift:53` — `modelContext.save()` errors are caught and printed to console only. Users get no feedback when saves fail, risking perceived data loss.

6. **No GPS coordinate validation on import.** `ImportTreesView.swift:134-201` and `ImportCollectionView.swift:99-193` accept any latitude/longitude values without range checks. Invalid coordinates (lat > 90, lon > 180) would corrupt data.

7. **N+1 query problem in importers.** `ImportTreesView.swift` calls `treeIDExists()` per tree, creating N separate fetch queries for N imported trees. Should batch-check IDs.

8. **`WatchConnectivityManager.swift:80-81` — Thread safety.** `pendingTrees` and `receivedTrees` are modified from WCSession delegate callbacks (background thread) and read from main thread without synchronization.

9. **No camera permission check.** `ImagePicker.swift` opens the camera picker without checking `AVCaptureDevice.authorizationStatus`. If permission is denied, this can fail without explanation.

---

## Medium

10. **`PhotoGalleryView.swift:77` — Array index as TabView tag.** If photos change while the fullscreen viewer is open, the index becomes invalid. Should use `photo.id` instead.

11. **`DuplicateTreesView.swift:196` — Aggressive duplicate detection.** 5 decimal places (~1m precision) may be tighter than GPS accuracy (typically 5-15m), creating false positives for distinct nearby trees.

12. **`TreeDetailView.swift:14-22` — Triple source of truth in edit mode.** Separate `@State` variables for species/variety/rootstock alongside `@Bindable tree` creates sync risk if edits are cancelled or the model changes externally.

13. **`SpeciesTextField.swift:58` — Task not cancelled on view dismissal.** The debounce task is only cancelled on the next keystroke, not in `.onDisappear`. Minor leak potential.

14. **No transaction boundaries in import.** `ImportCollectionView.swift:129-179` inserts multiple trees without rollback capability. A failure mid-import leaves partial data committed.

15. **`ExportView.swift:162` — Uses `DispatchQueue.global().async` instead of structured concurrency.** Should use Swift `Task` for cancellation support and consistency with the rest of the codebase.

---

## Accessibility

16. **`AccuracyBadge.swift` — Color-only accuracy indication.** No `accessibilityLabel` or `accessibilityValue`. Color-blind users and VoiceOver users get no accuracy information.

17. **`TreeRowView.swift:8-14` — Photo thumbnails lack accessibility labels.** Screen readers can't describe tree photos.

18. **Watch `CaptureView.swift:151-178` — `AccuracyRingView` has no accessibility value.** The progress ring is visual-only.

---

## Low / Code Quality

19. **In-memory search filtering.** `TreeListView.swift:14-23` filters all trees in Swift rather than using `#Predicate` at the SwiftData query level. Will degrade with large datasets.

20. **`PhotoGalleryView.swift:21-47` — Thumbnails re-downsampled on every render.** `ImageDownsampler.downsample()` is called in the view body with no caching layer.

21. **Redundant `@Query` declarations.** `TreeListView`, `iPadTreeListView`, and `TreeMapView` all run identical `@Query` fetches independently.

22. **Export files written to caches directory.** `CSVExporter`, `JSONExporter`, `GPXExporter` all write to `cachesDirectory`, which the OS can purge at any time before the user shares the file.

23. **No SwiftData indexes declared.** UUID-based predicates in `WatchTreeImporter.swift:14` and importers do full table scans. Adding `@Attribute(.unique)` or explicit indexes on `id` would help at scale.

24. **`WatchConnectivityManager.swift:74` — Pending tree queue in UserDefaults.** No size limit. If the watch is disconnected for an extended period, pending trees could grow to cause UserDefaults performance issues.

---

## What's Done Well

- **Adaptive layout** — Clean iPhone/iPad/Mac split using `horizontalSizeClass`
- **Memory-conscious photo handling** — External storage + `ImageDownsampler` for thumbnails
- **Watch sync resilience** — Pending queue with retry on reconnection
- **Export flexibility** — Three formats (CSV, JSON, GPX) with consistent API
- **Delete rules** — Cascade for photos/notes, nullify for collections is the right design
- **Keyboard shortcuts** on iPad (Cmd+N, Cmd+E, Cmd+1/2/3)
- **Schema versioning** set up with `TreesSchemaV1` + migration plan ready for future changes
