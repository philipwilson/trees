# Code Review: Trees iOS/watchOS App

**Date:** 2026-02-17

**5,649 lines across 41 Swift files** — SwiftUI + SwiftData (iOS 17+) with watchOS companion, CloudKit sync, and Mac Catalyst support. Overall a well-structured app with clean separation of concerns. Below are the issues worth addressing, grouped by severity.

---

## Critical — All Fixed

1. ~~**`TreesApp.swift` — `fatalError()` on ModelContainer init failure.**~~ **Fixed:** Falls back to local-only ModelContainer if CloudKit init fails. (`ecff12c`)

2. ~~**`WatchConnectivityManager.swift` — `receivedTrees` array never cleared.**~~ **Fixed:** Removed `receivedTrees` accumulation entirely; trees are passed directly to callback. (`ecff12c`)

3. ~~**`ImportTreesView.swift` — Delayed photo import race condition.**~~ **Fixed:** Task stored in `@State`, cancelled in `.onDisappear`, checks `Task.isCancelled` before each batch. (`ecff12c`)

4. ~~**`JSONExporter.swift` — OOM risk on large exports.**~~ **Fixed:** `exportToFile` streams per-tree with `autoreleasepool` when including photos. (`ecff12c`)

---

## High — All Fixed

5. ~~**Silent save failures throughout.**~~ **Fixed:** Added user-facing error alerts in `TreeDetailView`, `CollectionDetailView`, `AddTreesToCollectionView`, and `iPadTreeListView`. `TreeDetailView` stays in edit mode on failure so the user can retry. (`20717f0`)

6. ~~**No GPS coordinate validation on import.**~~ **Fixed:** Both `ImportTreesView` and `ImportCollectionView` validate lat/lon ranges and non-negative accuracy; invalid trees are skipped with count in result message. (`20717f0`)

7. ~~**N+1 query problem in importers.**~~ **Fixed:** Replaced per-tree `treeIDExists()` with single `fetchAllTreeIDs()` batch fetch into a `Set`. (`20717f0`)

8. ~~**`WatchConnectivityManager.swift` — Thread safety.**~~ **Fixed:** Removed `receivedTrees` (main concern). Added `assert(Thread.isMainThread)` to `sendTree()` and `retrySendingPendingTrees()`. (`ecff12c`, `20717f0`)

9. ~~**No camera permission check.**~~ **Fixed:** `PhotosPicker` checks `AVCaptureDevice.authorizationStatus` before opening camera; shows alert with Settings link if denied. (`20717f0`)

---

## Medium — All Fixed

10. ~~**`PhotoGalleryView.swift` — Array index as TabView tag.**~~ **Fixed:** Changed to `selectedPhoto: Photo?` and `currentPhotoID: UUID`. TabView tags use `photo.id`; removed retroactive `Int: Identifiable` conformance.

11. ~~**`DuplicateTreesView.swift` — Aggressive duplicate detection.**~~ **Fixed:** Widened coordinate rounding from 5 decimal places (~1m) to 4 decimal places (~11m) to match typical GPS accuracy.

12. ~~**`TreeDetailView.swift` — No way to cancel edits.**~~ **Fixed:** Added Cancel button (leading) in edit mode toolbar. Cancel discards uncommitted changes and new photos without saving.

13. ~~**`SpeciesTextField.swift` — Task not cancelled on view dismissal.**~~ **Fixed:** Added `.onDisappear { filterTask?.cancel() }` to clean up the debounce task.

14. ~~**`ImportCollectionView.swift` — No rollback on save failure.**~~ **Fixed:** Tracks inserted trees and new collection; on save failure, deletes all inserted objects from the context to prevent accidental persistence.

15. ~~**`ExportView.swift` — `DispatchQueue` instead of structured concurrency.**~~ **Fixed:** Replaced with `Task.detached` / `await MainActor.run` for consistency and cancellation support.

---

## Accessibility — Open

16. **`AccuracyBadge.swift` — Color-only accuracy indication.** No `accessibilityLabel` or `accessibilityValue`. Color-blind users and VoiceOver users get no accuracy information.

17. **`TreeRowView.swift:8-14` — Photo thumbnails lack accessibility labels.** Screen readers can't describe tree photos.

18. **Watch `CaptureView.swift:151-178` — `AccuracyRingView` has no accessibility value.** The progress ring is visual-only.

---

## Low / Code Quality — Open

19. **In-memory search filtering.** `TreeListView.swift:14-23` filters all trees in Swift rather than using `#Predicate` at the SwiftData query level. Will degrade with large datasets.

20. **`PhotoGalleryView.swift:21-47` — Thumbnails re-downsampled on every render.** `ImageDownsampler.downsample()` is called in the view body with no caching layer.

21. **Redundant `@Query` declarations.** `TreeListView`, `iPadTreeListView`, and `TreeMapView` all run identical `@Query` fetches independently.

22. **Export files written to caches directory.** `CSVExporter`, `JSONExporter`, `GPXExporter` all write to `cachesDirectory`, which the OS can purge at any time before the user shares the file.

23. **No SwiftData indexes declared.** UUID-based predicates in `WatchTreeImporter.swift:14` and importers do full table scans. Adding `@Attribute(.unique)` or explicit indexes on `id` would help at scale.

24. **`WatchConnectivityManager.swift:74` — Pending tree queue in UserDefaults.** No size limit. If the watch is disconnected for an extended period, pending trees could grow to cause UserDefaults performance issues.

---

## What's Done Well

- **Adaptive layout** — Clean iPhone/iPad/Mac split using `horizontalSizeClass`
- **Memory-conscious photo handling** — External storage + `ImageDownsampler` for thumbnails
- **Watch sync resilience** — Pending queue with retry on reconnection
- **Export flexibility** — Three formats (CSV, JSON, GPX) with consistent API
- **Delete rules** — Cascade for photos/notes, nullify for collections is the right design
- **Keyboard shortcuts** on iPad (Cmd+N, Cmd+E, Cmd+1/2/3)
- **Schema versioning** set up with `TreesSchemaV1` + migration plan ready for future changes
